<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Schema Documentation</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --header-bg: #e9ecef;
            --border-color: #dee2e6;
            --bg-color: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            min-height: 80vh;
        }

        /* Header */
        header {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
            padding-bottom: 1rem;
        }
        h1 { margin: 0; color: var(--primary-color); }
        .meta-info { color: #666; font-size: 0.9rem; margin-top: 5px; }

        /* Loading / Error */
        #status-msg {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: #666;
        }
        .error {
            color: #d9534f;
            background: #fdf7f7;
            padding: 20px;
            border: 1px solid #d9534f;
            border-radius: 4px;
            display: inline-block;
        }

        /* Table Design */
        .table-section {
            margin-bottom: 3rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .table-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-name { font-weight: bold; font-size: 1.1rem; font-family: monospace; }
        .table-comment { background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 12px; font-size: 0.85rem; }

        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); text-align: left; }
        th { background-color: var(--header-bg); color: var(--primary-color); font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        tr:last-child td { border-bottom: none; }

        /* Column Widths */
        th:nth-child(1) { width: 25%; } /* Name */
        th:nth-child(2) { width: 15%; } /* Type */
        th:nth-child(3) { width: 15%; } /* Attributes */
        th:nth-child(4) { width: 45%; } /* Comment */

        /* Badges */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; color: white; display: inline-block;}
        .badge-pk { background-color: #e74c3c; }
        .badge-nn { background-color: #95a5a6; }
        .badge-def { background-color: #2ecc71; }

        .code-font { font-family: monospace; color: #d63384; }
    </style>
</head>
<body>

<div class="container">
    <div id="app">
        <div id="status-msg">
            ⏳ Loading schema/schema.json ...
        </div>
    </div>
</div>

<script>
    // 設定: 読み込むファイルのパス
    const JSON_PATH = 'schema/schema.json';

    document.addEventListener('DOMContentLoaded', () => {
        fetchSchema();
    });

    async function fetchSchema() {
        const app = document.getElementById('app');

        try {
            const response = await fetch(JSON_PATH);

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const data = await response.json();
            renderSchema(data);

        } catch (error) {
            console.error(error);
            app.innerHTML = `
                <div id="status-msg">
                    <div class="error">
                        <strong>読み込みエラー</strong><br>
                        ファイルが見つからないか、ブラウザのセキュリティ制限によりブロックされました。<br><br>
                        <small>
                        ヒント:<br>
                        1. <code>${JSON_PATH}</code> が存在するか確認してください。<br>
                        2. HTMLを直接開くのではなく、Webサーバー経由(Live Server等)で開いてください。<br>
                        (エラー詳細: ${error.message})
                        </small>
                    </div>
                </div>
            `;
        }
    }

    function renderSchema(data) {
        const app = document.getElementById('app');
        let html = '';

        // 1. Header Info
        const dbName = data.name || 'Database';
        const dbVersion = data.driver?.database_version || '';

        html += `
            <header>
                <h1>${escapeHtml(dbName)}</h1>
                <div class="meta-info">${escapeHtml(dbVersion)}</div>
            </header>
        `;

        // 2. Tables Loop
        if (!data.tables || data.tables.length === 0) {
            html += '<p>テーブル定義がありません。</p>';
        } else {
            data.tables.forEach(table => {
                html += renderTable(table);
            });
        }

        app.innerHTML = html;
    }

    function renderTable(table) {
        // PK判定用セット作成
        const pkColumns = new Set();
        if (table.constraints) {
            table.constraints.forEach(c => {
                if (c.type === 'PRIMARY KEY') {
                    c.columns.forEach(col => pkColumns.add(col));
                }
            });
        }

        const tableName = escapeHtml(table.name);
        const tableComment = table.comment ? escapeHtml(table.comment) : '';

        // 行の生成
        const rows = table.columns.map(col => {
            const isPk = pkColumns.has(col.name);
            const isNotNull = col.nullable === false;
            const defaultVal = col.default || '';
            const comment = col.comment || '';

            // Badges
            let attributes = '';
            if (isNotNull) attributes += `<span class="badge badge-nn">Not Null</span>`;

            // Extra Info
            let extra = '';
            if (defaultVal) extra += `<div><span class="badge badge-def">Def</span> <span class="code-font">${escapeHtml(defaultVal)}</span></div>`;
            if (comment) extra += `<div>${escapeHtml(comment)}</div>`;

            // PK Icon
            const nameDisplay = isPk
                ? `<span class="badge badge-pk">PK</span>${escapeHtml(col.name)}`
                : escapeHtml(col.name);

            return `
                <tr>
                    <td class="code-font">${nameDisplay}</td>
                    <td>${escapeHtml(col.type)}</td>
                    <td>${attributes}</td>
                    <td>${extra}</td>
                </tr>
            `;
        }).join('');

        return `
            <div class="table-section">
                <div class="table-header">
                    <span class="table-name">${tableName}</span>
                    <span class="table-comment">${tableComment}</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Column</th>
                            <th>Type</th>
                            <th>Attributes</th>
                            <th>Comment / Default</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            </div>
        `;
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
</script>

</body>
</html>